# –ú–∞–≥–∏—è –°–æ—Å—Ç–æ—è–Ω–∏–π (FSM) - –£—á–∏–º –±–æ—Ç–∞ –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥! üß†üí¨

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–µ–±–µ, —á—Ç–æ —Ç—ã –∑–∞–ø–æ–ª–Ω—è–µ—à—å –∞–Ω–∫–µ—Ç—É –Ω–∞ —Å–∞–π—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ –≤–≤–æ–¥–∏—à—å –∏–º—è, –ø–æ—Ç–æ–º —Ñ–∞–º–∏–ª–∏—é, –ø–æ—Ç–æ–º email. –°–∞–π—Ç *–ø–æ–º–Ω–∏—Ç*, —á—Ç–æ —Ç—ã —É–∂–µ –≤–≤–µ–ª –∏–º—è, –∫–æ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–∞–º–∏–ª–∏—é. –û–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º "—Å–æ—Å—Ç–æ—è–Ω–∏–∏" –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã.

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—ã—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (`@router.message(...)`) –≤ `aiogram` **–Ω–µ –ø–æ–º–Ω—è—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ —Ç—ã —Å–¥–µ–ª–∞–µ—à—å –∫–æ–º–∞–Ω–¥—É `/register`, –∫–æ—Ç–æ—Ä–∞—è —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è", –∞ –ø–æ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à–ª–µ—Ç –∏–º—è, —Ç–æ –∫–∞–∫ –±–æ—Ç—É –ø–æ–Ω—è—Ç—å, —á—Ç–æ —ç—Ç–æ *–∏–º–µ–Ω–Ω–æ –∏–º—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é*, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ? –ö–∞–∫ –ø–æ—Ç–æ–º —Å–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –∏ —Å–≤—è–∑–∞—Ç—å –µ–≥–æ —Å —ç—Ç–∏–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏?

**–†–µ—à–µ–Ω–∏–µ:** **FSM (Finite State Machine)**! –≠—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É:

1.  –ù–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ **–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `–æ–∂–∏–¥–∞–Ω–∏–µ_–∏–º–µ–Ω–∏`, `–æ–∂–∏–¥–∞–Ω–∏–µ_–≤–æ–∑—Ä–∞—Å—Ç–∞`).
2.  **–ó–∞–ø–æ–º–∏–Ω–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *–≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è* (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∏–º—è).
3.  **–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å** –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –¥—Ä—É–≥–æ–µ –ø–æ –º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–î–∞–≤–∞–π —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É!

**–ü–ª–∞–Ω —É—Ä–æ–∫–∞ (–°—É–ø–µ—Ä-–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π):**

1.  **–ê–Ω–∞–ª–æ–≥–∏—è:** FSM - —ç—Ç–æ –∫–∞–∫... (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è).
2.  **–ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è?** (–ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ –ø—Ä–æ–±–ª–µ–º—É "–ø–∞–º—è—Ç–∏").
3.  **–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã FSM –≤ `aiogram`:**
    * `StatesGroup` –∏ `State`: –û–ø—Ä–µ–¥–µ–ª—è–µ–º "—à–∞–≥–∏" –Ω–∞—à–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞.
    * `FSMContext`: "–í–æ–ª—à–µ–±–Ω–∞—è —Å—É–º–∫–∞" –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.
    * –•—Ä–∞–Ω–∏–ª–∏—â–µ (`Storage`): –ì–¥–µ —ç—Ç–∞ "—Å—É–º–∫–∞" —Ö—Ä–∞–Ω–∏—Ç—Å—è? (`MemoryStorage` –∏ –Ω–∞–º–µ–∫ –Ω–∞ –±—É–¥—É—â–µ–µ).
4.  **–®–∞–≥ –∑–∞ —à–∞–≥–æ–º: –ü–∏—à–µ–º –ø—Ä–æ—Å—Ç—É—é –∞–Ω–∫–µ—Ç—É (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è):**
    * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π (—Ñ–∞–π–ª `states/registration.py`).
    * –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ (`/register`) - –≤—Ö–æ–¥ –≤ –ø–µ—Ä–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
    * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ (–≤–≤–æ–¥ –∏–º–µ–Ω–∏) - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ—Ö–æ–¥.
    * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —à–∞–≥–∞ (–≤–≤–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç–∞) - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥.
    * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —à–∞–≥–∞ (–≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞) - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏ **–≤—ã—Ö–æ–¥ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏–π**.
    * –°–±–æ—Ä–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ (`handlers/registration_handlers.py`).
5.  **"–°—Ç–æ–ø! –Ø –ø–µ—Ä–µ–¥—É–º–∞–ª!" - –û—Ç–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
    * –ö–æ–º–∞–Ω–¥–∞ `/cancel` –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–Ω–∫–µ—Ç—ã –Ω–∞ –ª—é–±–æ–º —à–∞–≥–µ.
    * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `StateFilter("*")`.
    * –ú–µ—Ç–æ–¥ `state.clear()` - –æ—á–∏—Å—Ç–∫–∞ "—Å—É–º–∫–∏".
6.  **"–û–π, —è –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–µ —Ç–æ!" - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞:**
    * –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞?
    * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
7.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å FSM:** –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã?
8.  **–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏.**
9.  **–ü—Ä–∞–∫—Ç–∏–∫–∞:** –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –º–∏–Ω–∏-–∞–Ω–∫–µ—Ç—É –∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É.

---

## 1. –ê–Ω–∞–ª–æ–≥–∏—è: FSM - —ç—Ç–æ –∫–∞–∫... ü§î

–ß—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–µ FSM, –ø—Ä–µ–¥—Å—Ç–∞–≤—å:

* **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã –æ–Ω–ª–∞–π–Ω:** –ö–∞–∂–¥–æ–µ –ø–æ–ª–µ (–∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç, –≥–æ—Ä–æ–¥) - —ç—Ç–æ **—Å–æ—Å—Ç–æ—è–Ω–∏–µ**. –°–∏—Å—Ç–µ–º–∞ –ø–æ–º–Ω–∏—Ç, —á—Ç–æ —Ç—ã –≤–≤–µ–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ª—è, –ø–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–∂–º–µ—à—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ).
* **–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Ä–æ–±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫:** "–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–∞–ª–∞–Ω—Å, –Ω–∞–∂–º–∏—Ç–µ 1" (–ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞"). "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" (—Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã"). "–°–ø–∞—Å–∏–±–æ, –≤–∞—à –±–∞–ª–∞–Ω—Å..." (–∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ).
* **–ú–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã (Wizard):** –ö–∞–∂–¥—ã–π —à–∞–≥ ("Next", "Choose folder", "Install") - —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–º–Ω–∏—Ç —Ç–≤–æ–∏ –≤—ã–±–æ—Ä—ã –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö.
* **–ê–≤—Ç–æ–º–∞—Ç —Å –Ω–∞–ø–∏—Ç–∫–∞–º–∏:**
    1.  –°–æ—Å—Ç–æ—è–Ω–∏–µ: `–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–Ω–µ–≥`.
    2.  –í—Å—Ç–∞–≤–∏–ª –∫—É–ø—é—Ä—É -> –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞`.
    3.  –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É -> –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `–í—ã–¥–∞—á–∞ –Ω–∞–ø–∏—Ç–∫–∞`.
    4.  –ù–∞–ø–∏—Ç–æ–∫ –≤—ã–¥–∞–Ω -> –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–Ω–µ–≥`.

–í–æ –≤—Å–µ—Ö —ç—Ç–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –µ—Å—Ç—å:
* **–ß–µ—Ç–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è**.
* **–ü–µ—Ä–µ—Ö–æ–¥—ã** –º–µ–∂–¥—É –Ω–∏–º–∏ –ø–æ –∫–∞–∫–æ–º—É-—Ç–æ —Å–æ–±—ã—Ç–∏—é (–≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏).
* –ß–∞—Å—Ç–æ –µ—Å—Ç—å **–ø–∞–º—è—Ç—å** –æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö (–∫–∞–∫–æ–π –Ω–∞–ø–∏—Ç–æ–∫ –≤—ã–±—Ä–∞–Ω, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–≤–µ–¥–µ–Ω—ã).

---

## 2. –ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è? ü§∑‚Äç‚ôÄÔ∏è

–í–µ—Ä–Ω–µ–º—Å—è –∫ –Ω–∞—à–µ–º—É –±–æ—Ç—É. –ë–µ–∑ FSM, –µ—Å–ª–∏ —Ç—ã –Ω–∞–ø–∏—à–µ—à—å —Ç–∞–∫:

```python
# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î –ë–ï–ó FSM

@router.message(Command("register"))
async def cmd_register(message: types.Message):
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:")
    # –ö–∞–∫ –±–æ—Ç—É —É–∑–Ω–∞—Ç—å, —á—Ç–æ –°–õ–ï–î–£–Æ–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ –∏–º—è? –ù–∏–∫–∞–∫!

@router.message(F.text) # –≠—Ç–æ—Ç —Ö—ç–Ω–¥–ª–µ—Ä –ª–æ–≤–∏—Ç –í–ï–°–¨ —Ç–µ–∫—Å—Ç
async def process_text(message: types.Message):
    user_text = message.text
    # –≠—Ç–æ –∏–º—è? –ò–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç? –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–∫—Å—Ç? –ë–æ—Ç –Ω–µ –∑–Ω–∞–µ—Ç!
    if ???: # –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º—ã –∂–¥–µ–º –∏–º—è?
         await message.answer("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç:")
    elif ???: # –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º—ã –∂–¥–µ–º –≤–æ–∑—Ä–∞—Å—Ç?
         await message.answer("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    else:
         # –û–±—ã—á–Ω–æ–µ —ç—Ö–æ –∏–ª–∏ –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞
         await message.answer(f"–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {user_text}")

```

–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–¥–æ. `process_text` –±—É–¥–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ *–ª—é–±–æ–µ* —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û–Ω –Ω–µ –∑–Ω–∞–µ—Ç, —Å–ø—Ä–æ—Å–∏–ª–∏ –ª–∏ –º—ã –∏–º—è –ø–µ—Ä–µ–¥ —ç—Ç–∏–º.

**FSM —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É**, –ø–æ–∑–≤–æ–ª—è—è –Ω–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç **—Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞**, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**.

---

## 3. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã FSM –≤ `aiogram` üõ†Ô∏è

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å FSM –≤ `aiogram` –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—â–∏:

### –∞) `StatesGroup` –∏ `State`: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—à–∏ "—à–∞–≥–∏"

`StatesGroup` - —ç—Ç–æ –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –æ–¥–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏).
`State` - —ç—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã.

```python
# –ü—Ä–∏–º–µ—Ä: states/registration.py
from aiogram.fsm.state import State, StatesGroup

class RegistrationStates(StatesGroup):
    waiting_for_name = State()      # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏
    waiting_for_age = State()       # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
    waiting_for_city = State()      # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π

# –ú—ã —Å–æ–∑–¥–∞–ª–∏ "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä" RegistrationStates
# –∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ "–ø–æ–ª–æ—á–∫–∏": waiting_for_name, waiting_for_age, waiting_for_city
```

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –∏–º–µ–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –Ω–∞—à–µ–π –∞–Ω–∫–µ—Ç—ã.

### –±) `FSMContext`: "–í–æ–ª—à–µ–±–Ω–∞—è —Å—É–º–∫–∞" üéí

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –≤ –∫–∞–∫–æ–µ-—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é), `aiogram` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç `FSMContext` (—á–∞—Å—Ç–æ –µ–≥–æ –Ω–∞–∑—ã–≤–∞—é—Ç `state`). –≠—Ç–æ **–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö** –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º **–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ**.

* **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:** –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –æ–±—ä–µ–∫—Ç—É, –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä `state: FSMContext` –≤ —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:

    ```python
    async def handle_name(message: types.Message, state: FSMContext):
        # –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ...
    ```

* **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã `FSMContext`:**
    * `await state.set_state(–ù—É–∂–Ω–æ–µ–°–æ—Å—Ç–æ—è–Ω–∏–µ)`: **–ü–µ—Ä–µ–≤–æ–¥–∏—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `await state.set_state(RegistrationStates.waiting_for_age)`).
    * `await state.get_state()`: **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç** —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'RegistrationStates:waiting_for_name'`) –∏–ª–∏ `None`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
    * `await state.update_data(–∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ, ...) `: **–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç** –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–≤ "—Å—É–º–∫–µ") –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–ø—Ä–∏–º–µ—Ä, `await state.update_data(name=message.text)`. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å.
    * `await state.get_data()`: **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç** —Å–ª–æ–≤–∞—Ä—å —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ "—Å—É–º–∫—É" –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`{'name': '–í–∞—Å—è', 'age': 30}`).
    * `await state.clear()`: **–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç** —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. **–û—á–µ–Ω—å –≤–∞–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ—Ü–µ—Å—Å–∞!**

### –≤) –•—Ä–∞–Ω–∏–ª–∏—â–µ (`Storage`): –ì–¥–µ –ª–µ–∂–∏—Ç "—Å—É–º–∫–∞"? üíæ

–û–±—ä–µ–∫—Ç—É `FSMContext` –Ω—É–∂–Ω–æ –≥–¥–µ-—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç **—Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π (storage)**.

* `MemoryStorage`: –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç. –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ **–≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏** –±–æ—Ç–∞.
    * **–ü–ª—é—Å:** –õ–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (–º—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ –≤ `main.py`: `dp = Dispatcher(storage=MemoryStorage())`).
    * **–ú–∏–Ω—É—Å:** **–í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞!** –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –±–æ—Ç–æ–≤ –∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
* **–î—Ä—É–≥–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤):**
    * `RedisStorage`: –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Redis (–±—ã—Å—Ç—Ä–∞—è key-value –±–∞–∑–∞). –î–∞–Ω–Ω—ã–µ **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –±–æ—Ç–æ–≤.
    * `MongoStorage`: –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ MongoDB.
    * `SQLAlchemyStorage` (–∏ –¥—Ä—É–≥–∏–µ –¥–ª—è SQL): –•—Ä–∞–Ω—è—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö (PostgreSQL, SQLite).
    * `FileStorage`: –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–∞—Ö (–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, —á–µ–º Redis/DB).

> **–ù–∞ —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MemoryStorage`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞. –ù–æ –ø–æ–º–Ω–∏, —á—Ç–æ –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, `RedisStorage`.**

---

## 4. –®–∞–≥ –∑–∞ —à–∞–≥–æ–º: –ü–∏—à–µ–º –ø—Ä–æ—Å—Ç—É—é –∞–Ω–∫–µ—Ç—É (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) üìù

–î–∞–≤–∞–π —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≥–¥–µ –±–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç –∏ –≥–æ—Ä–æ–¥.

### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è

–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª `states/registration.py`:

```python
# –§–∞–π–ª: states/registration.py
from aiogram.fsm.state import State, StatesGroup

class RegistrationStates(StatesGroup):
    waiting_for_name = State()
    waiting_for_age = State()
    waiting_for_city = State()

print("States defined!") # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
```

–ù–µ –∑–∞–±—É–¥—å —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª `states/__init__.py`, —á—Ç–æ–±—ã Python –º–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏.

### –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª `handlers/registration_handlers.py`:

```python
# –§–∞–π–ª: handlers/registration_handlers.py
from aiogram import Router, F, types, html
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import default_state # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º default_state

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
from states.registration import RegistrationStates

router = Router()

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /register ---
# –û–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞–∫–æ–º-–ª–∏–±–æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
@router.message(Command("register"), StateFilter(default_state))
async def start_registration(message: types.Message, state: FSMContext):
    await message.answer("–î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! ‚ú®\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:")
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏"
    await state.set_state(RegistrationStates.waiting_for_name)
    print(f"User {message.from_user.id} started registration, set state -> waiting_for_name")

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ ---
# –°—Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_name –ò –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–∫—Å—Ç
@router.message(RegistrationStates.waiting_for_name, F.text)
async def process_name(message: types.Message, state: FSMContext):
    user_name = message.text
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤ FSMContext ("–≤–æ–ª—à–µ–±–Ω—É—é —Å—É–º–∫—É")
    await state.update_data(name=user_name)
    print(f"User {message.from_user.id} entered name: {user_name}, saved to state data")
    await message.answer(f"–û—Ç–ª–∏—á–Ω–æ, {html.quote(user_name)}!\n–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç:")
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞"
    await state.set_state(RegistrationStates.waiting_for_age)
    print(f"User {message.from_user.id} set state -> waiting_for_age")

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ ---
# –°—Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_age
@router.message(RegistrationStates.waiting_for_age)
async def process_age(message: types.Message, state: FSMContext):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–∏—Å–ª–æ–º
    if not message.text or not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏.")
        print(f"User {message.from_user.id} entered invalid age: {message.text}")
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_age
        return # –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

    age = int(message.text)
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –≤–æ–∑—Ä–∞—Å—Ç–∞
    if age < 4 or age > 120:
        await message.answer("–•–º, —Ç–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–µ—Ç—Å—è –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        print(f"User {message.from_user.id} entered unlikely age: {age}")
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_age
        return # –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –≤ FSMContext
    await state.update_data(age=age)
    print(f"User {message.from_user.id} entered age: {age}, saved to state data")
    await message.answer(f"–ó–∞–ø–∏—Å–∞–ª –≤–æ–∑—Ä–∞—Å—Ç: {age}.\n–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:")
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞"
    await state.set_state(RegistrationStates.waiting_for_city)
    print(f"User {message.from_user.id} set state -> waiting_for_city")


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ ---
# –°—Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_city –ò –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–∫—Å—Ç
@router.message(RegistrationStates.waiting_for_city, F.text)
async def process_city(message: types.Message, state: FSMContext):
    city = message.text
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥
    await state.update_data(city=city)
    print(f"User {message.from_user.id} entered city: {city}, saved to state data")

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ "—Å—É–º–∫–∏"
    user_data = await state.get_data()
    print(f"User {message.from_user.id} finished registration. Data: {user_data}")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    name = user_data.get('name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
    age = user_data.get('age', '–ù–µ —É–∫–∞–∑–∞–Ω')
    city_saved = user_data.get('city', '–ù–µ —É–∫–∞–∑–∞–Ω')

    response_text = (
        f"üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ\n\n"
        f"–í–æ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n"
        f"üë§ –ò–º—è: <b>{html.quote(name)}</b>\n"
        f"üéÇ –í–æ–∑—Ä–∞—Å—Ç: <b>{age}</b>\n"
        f"üèôÔ∏è –ì–æ—Ä–æ–¥: <b>{html.quote(city_saved)}</b>\n\n"
        f"–°–ø–∞—Å–∏–±–æ!"
    )
    await message.answer(response_text, parse_mode="HTML")

    # –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await state.clear()
    print(f"User {message.from_user.id} state cleared.")
    # –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å default_state —è–≤–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # await state.set_state(default_state)

print("Registration handlers registered!") # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
```

–ù–µ –∑–∞–±—É–¥—å —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª `handlers/__init__.py`.

### –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ "—Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å" –Ω–∞—à–µ–º—É `Dispatcher` –æ–± —ç—Ç–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö. –û–±–Ω–æ–≤–∏–º `main.py`:

```python
# –§–∞–π–ª: main.py
import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.fsm.storage.memory import MemoryStorage # –ò—Å–ø–æ–ª—å–∑—É–µ–º MemoryStorage

from config import TOKEN # –í–∞—à —Ç–æ–∫–µ–Ω –∏–∑ config.py

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã –∏–∑ handlers
from handlers import handler as common_handler # –ù–∞—à —Å—Ç–∞—Ä—ã–π —Ä–æ—É—Ç–µ—Ä
from handlers import registration_handlers # –ù–∞—à –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
logging.basicConfig(level=logging.INFO)

async def main():
    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã Bot –∏ Dispatcher
    bot = Bot(token=TOKEN)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º MemoryStorage –¥–ª—è FSM
    storage = MemoryStorage()
    dp = Dispatcher(storage=storage)
    print("Bot and Dispatcher created")

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(common_handler.router)
    print("Common handlers router included")
    dp.include_router(registration_handlers.router)
    print("Registration handlers router included")

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∞–ø–¥–µ–π—Ç—ã (–µ—Å–ª–∏ –±–æ—Ç –±—ã–ª –≤—ã–∫–ª—é—á–µ–Ω)
    await bot.delete_webhook(drop_pending_updates=True)
    print("Webhook deleted, pending updates dropped")

    # –ó–∞–ø—É—Å–∫–∞–µ–º polling
    print("Starting polling...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        print("Bot stopped")
```

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**

1.  –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ `registration_handlers`.
2.  –ü–µ—Ä–µ–¥–∞–ª–∏ `MemoryStorage()` –≤ `Dispatcher`.
3.  –ü–æ–¥–∫–ª—é—á–∏–ª–∏ `registration_handlers.router` –∫ `Dispatcher` —Å –ø–æ–º–æ—â—å—é `dp.include_router()`. **–í–∞–∂–Ω–æ:** –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ —É –Ω–∏—Ö –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Ñ–∏–ª—å—Ç—Ä—ã. –û–±—ã—á–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ (–∫–∞–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) –∏–¥—É—Ç —Ä–∞–Ω—å—à–µ –æ–±—â–∏—Ö (–∫–∞–∫ —ç—Ö–æ).

**–ó–∞–ø—É—Å–∫–∞–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–π!**

* –û—Ç–ø—Ä–∞–≤—å `/register`. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å –∏–º—è.
* –û—Ç–ø—Ä–∞–≤—å –∏–º—è. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —Å–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç.
* –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –≤–æ–∑—Ä–∞—Å—Ç–∞. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤–≤–µ—Å—Ç–∏ —Ü–∏—Ñ—Ä—ã.
* –í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç. –ë–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç –≥–æ—Ä–æ–¥.
* –í–≤–µ–¥–∏ –≥–æ—Ä–æ–¥. –ë–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
* –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –≤–≤–µ—Å—Ç–∏ –≥–æ—Ä–æ–¥. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —ç—Ö–æ-–±–æ—Ç (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å), –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–∂–µ –æ—á–∏—â–µ–Ω–æ.
* –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/register`. –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ.

---

## 5. "–°—Ç–æ–ø! –Ø –ø–µ—Ä–µ–¥—É–º–∞–ª!" - –û—Ç–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è üö´

–ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∞ –ø–æ—Ç–æ–º –ø–µ—Ä–µ–¥—É–º–∞–ª? –ï–º—É –Ω—É–∂–µ–Ω —Å–ø–æ—Å–æ–± –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ª—é–±–æ–º —à–∞–≥–µ.

–î–æ–±–∞–≤–∏–º –∫–æ–º–∞–Ω–¥—É `/cancel` –≤ `handlers/registration_handlers.py`.

```python
# –§–∞–π–ª: handlers/registration_handlers.py
# ... (–∏–º–ø–æ—Ä—Ç—ã –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
from aiogram.fsm.state import default_state # –î–æ–±–∞–≤–ª–µ–Ω default_state

router = Router()

# --- –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω—ã ---
# –ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –í –õ–Æ–ë–û–ú –°–û–°–¢–û–Ø–ù–ò–ò (StateFilter("*"))
# –∏–ª–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: StateFilter(RegistrationStates.waiting_for_name, ...)
@router.message(Command("cancel"), StateFilter("*"))
async def cancel_registration(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state is None:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º –µ–º—É –æ–± —ç—Ç–æ–º
        await message.answer("–í—ã —Å–µ–π—á–∞—Å –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    print(f"User {message.from_user.id} cancelled state {current_state}")
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–∞–Ω–Ω—ã–µ
    await state.clear()
    # await state.set_state(default_state) # –ú–æ–∂–Ω–æ –∏ —Ç–∞–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ—á–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –≤ None
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –≤—ã—à–ª–∏ –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /register ---
# –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ default_state (–∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è)
# —á—Ç–æ–±—ã /register –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –≤–æ –≤—Ä–µ–º—è —Å–∞–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
@router.message(Command("register"), StateFilter(default_state))
async def start_registration(message: types.Message, state: FSMContext):
    # ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ ---
# ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ ---
# ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ ---
# ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

print("Registration handlers (with cancel) registered!")

```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

1.  `StateFilter("*")`: –≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **–≤ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**, –æ—Ç–ª–∏—á–Ω–æ–º –æ—Ç `None` (—Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
2.  –ü—Ä–æ–≤–µ—Ä–∫–∞ `current_state is None`: –ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç `/cancel`, –∫–æ–≥–¥–∞ –æ–Ω –∏ —Ç–∞–∫ –Ω–µ –±—ã–ª –Ω–∏ –≤ –∫–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
3.  `await state.clear()`: –°–Ω–æ–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã—Ö.

**–ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è `/cancel` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `aiogram` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è *–¥–æ* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –æ–±–∞ –º–æ–≥—É—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç `/cancel` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞). –í `aiogram 3.x` –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ `Router` –æ–±—ã—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Ä—è–¥–∫—É –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π. –ï—Å–ª–∏ `/cancel` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä–æ—É—Ç–µ—Ä–µ, —Ç–æ –ø–æ—Ä—è–¥–æ–∫ `dp.include_router()` –≤–ª–∏—è–µ—Ç.

**–¢–µ—Å—Ç–∏—Ä—É–π:** –ù–∞—á–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (`/register`), –≤–≤–µ–¥–∏ –∏–º—è, –∞ –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤—å `/cancel`. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ - –æ–Ω –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ (—ç—Ö–æ).

---

## 6. "–û–π, —è –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–µ —Ç–æ!" - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞ üñºÔ∏è‚û°Ô∏èüî¢

–í –Ω–∞—à–µ–π –∞–Ω–∫–µ—Ç–µ –º—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ç–æ, —á—Ç–æ –≤–æ–∑—Ä–∞—Å—Ç –≤–≤–µ–¥–µ–Ω —Ü–∏—Ñ—Ä–∞–º–∏. –ù–æ —á—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ –ø—Ä–∏—à–ª–µ—Ç —Ñ–æ—Ç–æ? –ò–ª–∏ —Å—Ç–∏–∫–µ—Ä –≤–º–µ—Å—Ç–æ –≥–æ—Ä–æ–¥–∞?

–ù–∞—à —Ç–µ–∫—É—â–∏–π –∫–æ–¥ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ `F.text` —Ç–∞–º, –≥–¥–µ –º—ã –∂–¥–µ–º —Ç–µ–∫—Å—Ç. –ù–æ –ª—É—á—à–µ —Å–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –æ–Ω –≤–≤–µ–ª —á—Ç–æ-—Ç–æ –Ω–µ —Ç–æ.

–î–æ–±–∞–≤–∏–º "–ª–æ–≤—É—à–∫–∏" –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤ `handlers/registration_handlers.py`:

```python
# –§–∞–π–ª: handlers/registration_handlers.py
# ... (–∏–º–ø–æ—Ä—Ç—ã –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

router = Router()

# --- –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω—ã ---
# ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /register ---
# ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ (–∂–¥–µ–º –¢–ï–ö–°–¢) ---
@router.message(RegistrationStates.waiting_for_name, F.text)
async def process_name(message: types.Message, state: FSMContext):
    # ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –õ–æ–≤—É—à–∫–∞ –¥–ª—è –ù–ï —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_name ---
@router.message(RegistrationStates.waiting_for_name)
async def process_name_invalid(message: types.Message):
    await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è —Ç–µ–∫—Å—Ç–æ–º.")
    print(f"User {message.from_user.id} sent invalid data type for name: {message.content_type}")


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ (–∂–¥–µ–º –¢–ï–ö–°–¢ —Å —Ü–∏—Ñ—Ä–∞–º–∏) ---
@router.message(RegistrationStates.waiting_for_age, F.text) # –£—Ç–æ—á–Ω—è–µ–º, —á—Ç–æ –∂–¥–µ–º —Ç–µ–∫—Å—Ç
async def process_age(message: types.Message, state: FSMContext):
    # ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π isdigit)

# --- –õ–æ–≤—É—à–∫–∞ –¥–ª—è –ù–ï —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_age ---
@router.message(RegistrationStates.waiting_for_age)
async def process_age_invalid(message: types.Message):
    await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ç–µ–∫—Å—Ç–æ–º (—Ü–∏—Ñ—Ä–∞–º–∏).")
    print(f"User {message.from_user.id} sent invalid data type for age: {message.content_type}")


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ (–∂–¥–µ–º –¢–ï–ö–°–¢) ---
@router.message(RegistrationStates.waiting_for_city, F.text)
async def process_city(message: types.Message, state: FSMContext):
    # ... (–∫–æ–¥ –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

# --- –õ–æ–≤—É—à–∫–∞ –¥–ª—è –ù–ï —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_city ---
@router.message(RegistrationStates.waiting_for_city)
async def process_city_invalid(message: types.Message):
    await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–º.")
    print(f"User {message.from_user.id} sent invalid data type for city: {message.content_type}")

print("Registration handlers (with cancel and validation) registered!")
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1.  –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ (—Å–æ—Å—Ç–æ—è–Ω–∏—è) –º—ã —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ–º **–¥–≤–∞** –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:
    * –ü–µ—Ä–≤—ã–π: `RegistrationStates.–ò–º—è–°–æ—Å—Ç–æ—è–Ω–∏—è, F.text` - –ª–æ–≤–∏—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** —Ç–∏–ø –≤–≤–æ–¥–∞ (—Ç–µ–∫—Å—Ç).
    * –í—Ç–æ—Ä–æ–π: `RegistrationStates.–ò–º—è–°–æ—Å—Ç–æ—è–Ω–∏—è` (–±–µ–∑ `F.text`) - –ª–æ–≤–∏—Ç **–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ**, —á—Ç–æ –ø—Ä–∏—à–ª–æ –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (—Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.).
2.  Aiogram –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª —Ç–µ–∫—Å—Ç, —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–≤—ã–π. –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–µ —Ç–µ–∫—Å—Ç, –ø–µ—Ä–≤—ã–π –Ω–µ –ø–æ–¥–æ–π–¥–µ—Ç, –∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Ç–æ—Ä–æ–π (–Ω–∞—à–∞ "–ª–æ–≤—É—à–∫–∞").
3.  –í "–ª–æ–≤—É—à–∫–µ" –º—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ **–Ω–µ –º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ**. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —à–∞–≥–µ –∞–Ω–∫–µ—Ç—ã.

**–¢–µ—Å—Ç–∏—Ä—É–π:** –ù–∞—á–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∏ –∫–æ–≥–¥–∞ –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –∏–º—è, –æ—Ç–ø—Ä–∞–≤—å –µ–º—É —Ñ–æ—Ç–æ –∏–ª–∏ —Å—Ç–∏–∫–µ—Ä. –û–Ω –¥–æ–ª–∂–µ–Ω –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç.

---

## 7. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å FSM üìÇ

–ö–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å—Ç–µ—Ç, –≤–∞–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–º. –î–ª—è FSM —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–∞–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```
your_bot_project/
‚îú‚îÄ‚îÄ venv/                 # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ main.py               # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bot, Dispatcher, –∑–∞–ø—É—Å–∫
‚îú‚îÄ‚îÄ config.py             # –¢–æ–∫–µ–Ω –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ requirements.txt      # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (aiogram, etc.)
‚îú‚îÄ‚îÄ states/               # –ü–∞–ø–∫–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ registration.py   # –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (RegistrationStates)
‚îÇ   ‚îî‚îÄ‚îÄ quiz.py           # –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã (QuizStates) ...
‚îú‚îÄ‚îÄ handlers/             # –ü–∞–ø–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª
‚îÇ   ‚îú‚îÄ‚îÄ handler.py        # –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (start, help, echo...)
‚îÇ   ‚îú‚îÄ‚îÄ registration_handlers.py # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ FSM
‚îÇ   ‚îî‚îÄ‚îÄ quiz_handlers.py  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã FSM ...
‚îî‚îÄ‚îÄ utils/                # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ keyboards/            # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ö–Ω–æ–ø–∫–∏
    ‚îî‚îÄ‚îÄ ...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

* **–õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:** –°–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ.
* **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ FSM-—Å—Ü–µ–Ω–∞—Ä–∏–∏ (–≤–∏–∫—Ç–æ—Ä–∏–Ω—ã, –∑–∞–∫–∞–∑—ã), –Ω–µ –∑–∞—Ö–ª–∞–º–ª—è—è –æ–¥–∏–Ω —Ñ–∞–π–ª.
* **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:** –ü–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ –∏—Å–∫–∞—Ç—å –∫–æ–¥, –æ—Ç–Ω–æ—Å—è—â–∏–π—Å—è –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

---

## 8. –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ ‚ö†Ô∏è

* **–í–°–ï–ì–î–ê –æ—á–∏—â–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ!** –ó–∞–±—ã—Ç—ã–π `await state.clear()` –≤ –∫–æ–Ω—Ü–µ FSM-—Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Ç–æ–º—É, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–∑–∞—Å—Ç—Ä—è–Ω–µ—Ç" –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ –Ω–µ —Å–º–æ–∂–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º.
* **–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ `await`!** –í—Å–µ –º–µ—Ç–æ–¥—ã `FSMContext` (`set_state`, `update_data`, `get_data`, `clear`) - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –∏–º –Ω—É–∂–µ–Ω `await`.
* **–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤–∞–∂–µ–Ω.** –û—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –æ—Ç–º–µ–Ω—ã (`StateFilter("*")`) –∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ë–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —Ä–∞–Ω—å—à–µ –º–µ–Ω–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö.
* **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `StateFilter` –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞—Ö.** –ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ `@router.message()` - —ç—Ç–æ —Ñ–∏–ª—å—Ç—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è.
* **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –≤–≤–æ–¥.** –ù–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞–Ω–Ω—ã–º –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–∏–ø, –¥–∏–∞–ø–∞–∑–æ–Ω, —Ñ–æ—Ä–º–∞—Ç —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.
* **–î–∞–≤–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.** –ï—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, —Å–∫–∞–∂–∏—Ç–µ –µ–º—É –æ–± —ç—Ç–æ–º. –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.
* **–í—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.** `MemoryStorage` —Ö–æ—Ä–æ—à –¥–ª—è –Ω–∞—á–∞–ª–∞, –Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω—É–∂–µ–Ω `RedisStorage` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥.
* **–ù–µ —É—Å–ª–æ–∂–Ω—è–π—Ç–µ –±–µ–∑ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.** –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å, FSM –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–µ–Ω. –ù–æ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –∏–∑ 2+ —à–∞–≥–æ–≤ –æ–Ω –∏–¥–µ–∞–ª–µ–Ω.

---

## 9. –ü—Ä–∞–∫—Ç–∏–∫–∞: –¢–≤–æ—è –æ—á–µ—Ä–µ–¥—å! üöÄ

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ —Ç—ã –≤–æ–æ—Ä—É–∂–µ–Ω –∑–Ω–∞–Ω–∏—è–º–∏ FSM, –ø–æ–ø—Ä–æ–±—É–π —Å–æ–∑–¥–∞—Ç—å —á—Ç–æ-—Ç–æ —Å–≤–æ–µ!

**–ò–¥–µ—è 1: –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏**

1.  –°–æ–∑–¥–∞–π —Å–æ—Å—Ç–æ—è–Ω–∏—è: `FeedbackStates`: `waiting_for_feedback_message`, `waiting_for_confirmation`.
2.  –ö–æ–º–∞–Ω–¥–∞ `/feedback` –Ω–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.
3.  –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ? (–¥–∞/–Ω–µ—Ç)". –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `waiting_for_confirmation`.
4.  –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç "–¥–∞", –±–æ—Ç –ø–∏—à–µ—Ç "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!" –∏ –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ. (–í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –æ–Ω –±—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –æ—Ç–∑—ã–≤ –∞–¥–º–∏–Ω—É).
5.  –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç "–Ω–µ—Ç", –±–æ—Ç –ø–∏—à–µ—Ç "–û—Ç–º–µ–Ω–µ–Ω–æ" –∏ –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
6.  –î–æ–±–∞–≤—å –∫–æ–º–∞–Ω–¥—É `/cancel`.

**–ò–¥–µ—è 2: –ú–∏–Ω–∏-–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞**

1.  –°–æ–∑–¥–∞–π —Å–æ—Å—Ç–æ—è–Ω–∏—è: `QuizStates`: `question_1`, `question_2`, `results`.
2.  –°–æ–∑–¥–∞–π —Å–ª–æ–≤–∞—Ä—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏.
3.  –ö–æ–º–∞–Ω–¥–∞ `/quiz` –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—É, –∑–∞–¥–∞–µ—Ç –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏ —Å—Ç–∞–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `question_1`. –°–æ—Ö—Ä–∞–Ω—è–π —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `state.update_data(score=0)`.
4.  –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –¥–ª—è `question_1` –ø—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç, –æ–±–Ω–æ–≤–∏ —Å—á–µ—Ç (`user_data = await state.get_data(); current_score = user_data.get('score', 0); await state.update_data(score=current_score + 1)`), –∑–∞–¥–∞–π –≤—Ç–æ—Ä–æ–π –≤–æ–ø—Ä–æ—Å –∏ –ø–µ—Ä–µ–≤–µ–¥–∏ –≤ `question_2`.
5.  –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –¥–ª—è `question_2` —Å–¥–µ–ª–∞–π —Ç–æ –∂–µ —Å–∞–º–æ–µ, –∞ –∑–∞—Ç–µ–º –ø–æ–∫–∞–∂–∏ –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç –∏ –æ—á–∏—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (`state.clear()`).
6.  –î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∫–æ–º–∞–Ω–¥—É `/cancel`.

---

–§—É—Ö! –≠—Ç–æ –±—ã–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π —É—Ä–æ–∫! üòÖ –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π - —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∏ –ø–æ–Ω–∞—á–∞–ª—É –æ–Ω –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å—Å—è —Å–ª–æ–∂–Ω—ã–º. –ù–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Ç—ã –ø–æ–π–º–µ—à—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø (—Å–æ—Å—Ç–æ—è–Ω–∏–µ -> —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö -> –ø–µ—Ä–µ—Ö–æ–¥ -> ... -> –æ—á–∏—Å—Ç–∫–∞), —Ç—ã —Å–º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª–µ–µ —É–º–Ω—ã—Ö –∏ –ø–æ–ª–µ–∑–Ω—ã—Ö –±–æ—Ç–æ–≤.

–ù–µ –±–æ–π—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –∑–∞–≥–ª—è–¥—ã–≤–∞—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é `aiogram` –ø–æ FSM –∏ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã! –£–¥–∞—á–∏!
